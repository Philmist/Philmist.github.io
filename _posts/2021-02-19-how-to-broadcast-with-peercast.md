---
# Feel free to add content and custom Front Matter to this file.
# To modify the layout, see https://jekyllrb.com/docs/themes/#overriding-theme-defaults

layout: post
title: "PeercastStationを使って配信する方法"
---

だいたいのところは[Peercast視聴者Wikiのリンク](https://peca.nemusg.com/index.php?PeerCast%C6%B3%C6%FE)
から飛べる
[PeerCast BootCamp](https://w.atwiki.jp/akuta_bi/)
でわかるんですが、
補足を入れながら説明します。

# Peercastの概要

PeercastはP2Pで配信を行なっています。

![Peercastのリレー図](/assets/images/pecast_port/peca_relay.svg)

これはどういうことかというと、
配信動画が配信者から視聴者への経路だけで流れるのではなく、
視聴者から視聴者への経路でも受けわたされるということです。
これがPeercastの最大の特長で長所であり、そして欠点でもあります。

雑に言うと特別な配信用のサイトを経由しなくても配信できるということです。
それは逆に言うとPeercastStationのようなソフトを用意しないと配信できないし、
全てが配信者と視聴者の善意によって成り立つということでもあります。

## ポート開放をする意味

Peercastはポート開放しないと見れないとよく言われています。
これはある一面では正しく、もう一面では間違っています。

まず間違っている面から言うと、
単に配信を視聴するだけなら何も設定せずに見ることが出来ます。
これはなぜかというと先の図で上流からデータを受けとる分には設定が必要ないからです。

逆に正しい面はと言うと、
配信を下流(他の視聴者)に流せないために上流から蹴られやすいからです。
PeercastStationの場合、下流に流せない状態、俗にポート0と言われますが、
この状態で視聴している人をすぐに切ることはしません。
しかしながら、他のPeercast(IM版とYT版があります)を使っている場合や、
上流に余裕が無くなって他の視聴者を受け入れることが出来ない場合は、
ポート0の視聴者は切断されてしまいます。

他の視聴者が見れない状態を作らず、
なおかつ自分が継続して見ることが出来る環境を作るために、
ポート開放と呼ばれる作業が必要なのです。

## そもそもポート開放とは

ではポート開放とはそもそもどういうことなのでしょうか。
それにはまずIPアドレスとポートについて知る必要があります。

![IPアドレスとポート](/assets/images/pecast_port/peca_ip_and_port.svg)

インターネットで通信をする場合はグローバルIPアドレスとポートを指定して通信します。

グローバルIPアドレスはインターネットにつながっている端末を指定するもので
それはインターネットの中で唯一のものです。
ポートというのはその中に複数存在する「口」のようなものです。
ちなみにどのポートがどのソフトで使われるというのはあらかじめ決まっていることが多いです。

さて問題は1つのグローバルIPアドレスがインターネットで唯一のものであるということです。
通常の(IPv4の)インターネットの場合、
グローバルIPアドレスは契約ごとに1つしか与えられない場合がほとんどです。
ですが最近では複数の機器をインターネットにつなぐことが普通になっています。
この場合、どうやって複数の機器をインターネットにつなげるのでしょうか。

![NAPT](/assets/images/pecast_port/peca_napt.svg)

鍵はグローバルIPアドレスは1つなのに対してポートは複数あるということです。
ということは自分の持っているグローバルIPアドレスのあるポートに対して、
特定の機器を割り当てれば複数の機器でインターネットを使えるのではないでしょうか。

このような考えで1つの(グローバル)IPアドレスに複数の機器を割り当てる技術を
**NAPT(Network Address Port Translation)**
とか
**IPマスカレード**
と呼びます。
その中でも特に
**グローバルIPの特定のポートを特定の機器の特定のポートに割り当てる**
機能を
**ポートフォワーディング**
や
**静的NAPT**
などと呼び、これが俗にポート開放と呼ばれています。
なぜこれがポート開放と呼ばれるかというと、
**特定のポートを指定すれば特定の機器につながることが外からわかる**
からです。

## 最近の面倒くさいポート開放

さてこのポート開放ですが、最近では非常に面倒くさいものとなりつつあります。

Peercastでよく使われるインターネットの場合、
先のグローバルIPアドレスはIPv4アドレスと呼ばれる形式のものになっています。
このIPv4アドレスは世界中でインターネットが使われていった結果、
誰のものにもなっていない、
空いているグローバルIPv4アドレスは10年くらい前に無くなってしまいました。

そして日本(というかだいたいはNTT)特有の面倒くさい話として、
NTTフレッツ網を経由して
インターネットプロバイダにつないでIPv4アドレスを使用した通信を行なう場合、
NTTにおいてあるプロバイダの中継をしている機器で渋滞を起こしてしまい、
このせいでインターネットが遅いと言われるようになってしまいました
(雑な説明だけど許して)。
「じゃあこの中継する機器を使わなければいいじゃないか」となって、
さらに「枯渇しているIPv4アドレスを節約したくない？」となって出てきたのが、
**IPv4 over IPv6**
とか呼ばれるやつです。

先にグローバルIPv4アドレスは無くなったと書きましたが、
それに対処する方法として
グローバルIPアドレスの形式を変えてしまえという話になりました。
この別の形式のアドレスがIPv6アドレスです。
このIPv6アドレスはウルトラものすごくたくさんあって、
すんごい雑に割り当ててもよくなったので、
各ユーザーに1つではなくて各機器に1つという単位で割り当てられています。
しかし問題なのは
**グローバルIPv6アドレスではグローバルIPv4アドレスにつなげない**
ということなのです。
なぜなら宛て先の形式が違ってしまっているからですね。

実はこのIPv6アドレスを使うと、
NTTの中継している機器を使わないでインターネットにつなぐことができます。
つまり渋滞する部分をスキップできるので速くなります。
渋滞している部分をスキップして、
なおかつグローバルIPv4アドレスを節約するには
インターネットにつなぐ直前まではIPv6アドレスを使い、
その後はIPv4アドレスにすればいいのではないのでしょうか。
この直前までIPv6にしてあとはIPv4にする技術が
**IPv4 over IPv6**
と言われるもので、
その方法として
**DS-Lite**
とか
**MAP-E**
というものがあります。

さて先に1つのグローバルIPアドレスを複数の機器で使う話をしましたが、
このIPv4 over IPv6も似たような理屈で使用するIPv4アドレスを節約しています。
つまり
**グローバルIPv4アドレスのポートをそれぞれの利用者に割り振っている**
ということであり、
**1つのグローバルIPv4アドレスのポートを利用者が自由に選べない**
ということです(例外あり)。
しかし
*MAP-Eは割り振られるポートが利用者ごとに決まっている*
ので
**MAP-Eではポート番号にこだわりが無ければポート開放ができる**
ということになります。
なお、
*IPv4 over IPv6のどの方式を選んでいるかはプロバイダによって異なります*。


